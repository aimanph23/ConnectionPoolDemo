<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JVM Monitoring Dashboard - CPU & Memory</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-card .icon {
            font-size: 1.5em;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-good {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
        }

        .status-critical {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .detail-item .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-item .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .timestamp {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-link:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ•Ô∏è JVM Monitoring Dashboard</h1>
            <p class="subtitle">Real-time CPU & Memory Monitoring</p>
            <div class="nav-links">
                <a href="/home" class="nav-link">üè† Home</a>
                <a href="/dashboard/hikari" class="nav-link">üíß HikariCP</a>
                <a href="/dashboard/threadpool" class="nav-link">üßµ Thread Pool</a>
                <a href="/dashboard/tomcat" class="nav-link">üê± Tomcat</a>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3><span class="icon">üß†</span>Heap Memory</h3>
                <div class="stat-value" id="heapUsed">0 MB</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="heapProgress" style="width: 0%">0%</div>
                </div>
                <div class="stat-label" id="heapMax">of 0 MB</div>
            </div>

            <div class="stat-card">
                <h3><span class="icon">‚ö°</span>CPU Usage</h3>
                <div class="stat-value" id="cpuUsage">0%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cpuProgress" style="width: 0%">0%</div>
                </div>
                <div class="stat-label" id="cpuCores">0 cores available</div>
            </div>

            <div class="stat-card">
                <h3><span class="icon">üßµ</span>Threads</h3>
                <div class="stat-value" id="threadCount">0</div>
                <div class="stat-label">
                    Peak: <span id="peakThreads">0</span> | 
                    Daemon: <span id="daemonThreads">0</span>
                </div>
            </div>

            <div class="stat-card">
                <h3><span class="icon">‚è±Ô∏è</span>Uptime</h3>
                <div class="stat-value" id="uptime">0s</div>
                <div class="stat-label" id="vmInfo">Java VM</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-container">
            <h3>üìä Memory Usage Over Time</h3>
            <div class="chart-wrapper">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>‚ö° CPU Usage Over Time</h3>
            <div class="chart-wrapper">
                <canvas id="cpuChart"></canvas>
            </div>
        </div>

        <!-- Detailed Metrics -->
        <div class="chart-container">
            <h3>üìã Detailed Metrics</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="label">Non-Heap Memory</div>
                    <div class="value" id="nonHeapUsed">0 MB</div>
                </div>
                <div class="detail-item">
                    <div class="label">Total Memory</div>
                    <div class="value" id="totalMemory">0 MB</div>
                </div>
                <div class="detail-item">
                    <div class="label">Loaded Classes</div>
                    <div class="value" id="loadedClasses">0</div>
                </div>
                <div class="detail-item">
                    <div class="label">System Load</div>
                    <div class="value" id="systemLoad">0.00</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">üóëÔ∏è Garbage Collection</h3>
            <div class="detail-grid" id="gcMetrics">
                <!-- GC metrics will be inserted here -->
            </div>
        </div>

        <div class="timestamp" id="timestamp">Last updated: Never</div>
    </div>

    <script>
        // Chart configuration
        const maxDataPoints = 60;
        const memoryData = {
            labels: [],
            datasets: [{
                label: 'Heap Used (MB)',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Non-Heap Used (MB)',
                data: [],
                borderColor: '#764ba2',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                tension: 0.4,
                fill: true
            }]
        };

        const cpuData = {
            labels: [],
            datasets: [{
                label: 'Process CPU %',
                data: [],
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4,
                fill: true
            }]
        };

        const memoryChart = new Chart(document.getElementById('memoryChart'), {
            type: 'line',
            data: memoryData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Memory (MB)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        const cpuChart = new Chart(document.getElementById('cpuChart'), {
            type: 'line',
            data: cpuData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'CPU Usage (%)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // Connect to SSE stream
        const eventSource = new EventSource('/api/jvm/stream');

        eventSource.addEventListener('jvm-metrics', function(event) {
            const data = JSON.parse(event.data);
            updateDashboard(data);
        });

        eventSource.onerror = function(error) {
            console.error('SSE Error:', error);
            document.getElementById('timestamp').textContent = 'Connection lost. Retrying...';
        };

        function updateDashboard(data) {
            const memory = data.memory;
            const cpu = data.cpu;
            const threads = data.threads;

            // Update heap memory
            const heapUsedMB = Math.round(memory.heap.usedBytes / (1024 * 1024));
            const heapMaxMB = Math.round(memory.heap.maxBytes / (1024 * 1024));
            const heapPercent = memory.heap.usagePercent;

            document.getElementById('heapUsed').textContent = heapUsedMB + ' MB';
            document.getElementById('heapMax').textContent = `of ${heapMaxMB} MB`;
            document.getElementById('heapProgress').style.width = heapPercent + '%';
            document.getElementById('heapProgress').textContent = heapPercent + '%';
            document.getElementById('heapProgress').className = 'progress-fill ' + getStatusClass(heapPercent);

            // Update CPU
            const cpuLoad = parseCpuLoad(cpu.processCpuLoad);
            document.getElementById('cpuUsage').textContent = cpuLoad.toFixed(1) + '%';
            document.getElementById('cpuProgress').style.width = cpuLoad + '%';
            document.getElementById('cpuProgress').textContent = cpuLoad.toFixed(1) + '%';
            document.getElementById('cpuProgress').className = 'progress-fill ' + getStatusClass(cpuLoad);
            document.getElementById('cpuCores').textContent = cpu.availableProcessors + ' cores available';

            // Update threads
            document.getElementById('threadCount').textContent = threads.threadCount;
            document.getElementById('peakThreads').textContent = threads.peakThreadCount;
            document.getElementById('daemonThreads').textContent = threads.daemonThreadCount;

            // Update non-heap
            const nonHeapUsedMB = Math.round(memory.nonHeap.usedBytes / (1024 * 1024));
            document.getElementById('nonHeapUsed').textContent = nonHeapUsedMB + ' MB';

            // Update total memory
            document.getElementById('totalMemory').textContent = memory.totalUsed;

            // Update system load
            document.getElementById('systemLoad').textContent = cpu.systemLoadAverage.toFixed(2);

            // Update charts
            const now = new Date().toLocaleTimeString();
            
            if (memoryData.labels.length >= maxDataPoints) {
                memoryData.labels.shift();
                memoryData.datasets[0].data.shift();
                memoryData.datasets[1].data.shift();
            }
            
            memoryData.labels.push(now);
            memoryData.datasets[0].data.push(heapUsedMB);
            memoryData.datasets[1].data.push(nonHeapUsedMB);
            memoryChart.update('none');

            if (cpuData.labels.length >= maxDataPoints) {
                cpuData.labels.shift();
                cpuData.datasets[0].data.shift();
            }
            
            cpuData.labels.push(now);
            cpuData.datasets[0].data.push(cpuLoad);
            cpuChart.update('none');

            // Update timestamp
            document.getElementById('timestamp').textContent = 'Last updated: ' + new Date().toLocaleString();
        }

        function parseCpuLoad(cpuLoadStr) {
            if (typeof cpuLoadStr === 'string') {
                return parseFloat(cpuLoadStr.replace('%', ''));
            }
            return cpuLoadStr * 100;
        }

        function getStatusClass(percent) {
            if (percent < 70) return 'status-good';
            if (percent < 90) return 'status-warning';
            return 'status-critical';
        }

        // Initial load
        fetch('/api/jvm/metrics')
            .then(response => response.json())
            .then(data => {
                updateDashboard(data);
                
                // Update runtime info
                document.getElementById('uptime').textContent = data.runtime.uptime;
                document.getElementById('vmInfo').textContent = data.runtime.vmName;
                
                // Update classes
                document.getElementById('loadedClasses').textContent = data.classLoading.loadedClassCount;
                
                // Update GC metrics
                const gcContainer = document.getElementById('gcMetrics');
                gcContainer.innerHTML = '';
                for (const [name, info] of Object.entries(data.gc)) {
                    const div = document.createElement('div');
                    div.className = 'detail-item';
                    div.innerHTML = `
                        <div class="label">${name}</div>
                        <div class="value">${info.collectionCount} collections</div>
                        <div class="stat-label">${info.collectionTime}</div>
                    `;
                    gcContainer.appendChild(div);
                }
            })
            .catch(error => console.error('Error loading initial data:', error));
    </script>
</body>
</html>
